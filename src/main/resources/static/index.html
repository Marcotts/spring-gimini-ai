<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chat – spring-gemini-ai</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #10b981;
      --danger: #ef4444;
      --border: #1f2937;
      --header-h: 52px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sidebar-w: 260px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text);
      display: flex; flex-direction: column; min-height: 100vh;
    }
    header {
      position: sticky; top: 0; z-index: 50;
      border-bottom: 1px solid var(--border); background: var(--panel);
      height: var(--header-h);
      padding: 10px 16px; display: flex; align-items: center; gap: 12px;
    }
    header h1 { font-size: 16px; margin: 0; white-space: nowrap; }
    header .right { margin-left: auto; display: flex; gap: 8px; align-items: center; overflow: hidden; }
    header .right > * { white-space: nowrap; }

    main { flex: 1; min-height: 0; display: grid; grid-template-columns: var(--sidebar-w) 1fr; }

    /* Sidebar */
    #sidebar { border-right: 1px solid var(--border); background: #0b0f1a; display: flex; flex-direction: column; min-height: 0; }
    #sidebar .top { padding: 10px; display: grid; gap: 8px; border-bottom: 1px solid var(--border); }
    #sidebar .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    #sidebar button { background: #1f3a2e; color: #c1f0da; border: 1px solid #064e3b; padding: 6px 8px; border-radius: 6px; font-size: 12px; }
    #sidebar button.danger { background: #3b0d0d; color: #fecaca; border-color: #7f1d1d; }
    #sessionList { flex: 1; overflow: auto; padding: 8px; }
    .session-item { display: grid; gap: 2px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: #0b1220; cursor: pointer; }
    .session-item.active { outline: 2px solid #065f46; }
    .session-title { font-weight: 600; font-size: 13px; color: #93c5fd; }
    .session-meta { font-size: 12px; color: var(--muted); }

    /* Chat area */
    #chatArea { display: grid; grid-template-rows: 1fr auto; min-height: 0; }
    #messages { padding: 16px; overflow: auto; display: flex; flex-direction: column; gap: 6px; }

    .bubble { max-width: 900px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; margin: 6px 0; white-space: pre-wrap; line-height: 1.4; }
    .user { background: #0b2530; border-color: #12303f; align-self: flex-start; }
    .ai { background: #111827; border-color: #1f2937; }
    .row { display: flex; }
    .row.user { justify-content: flex-start; }
    .row.ai { justify-content: flex-start; }

    .ai .tools { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; }
    .ai .tools .btn-sm { background: #0e1b18; color: #a7f3d0; border: 1px solid #064e3b; padding: 2px 8px; border-radius: 999px; font-size: 12px; cursor: pointer; }
    .ai .tools .btn-sm:hover { filter: brightness(1.1); }
    .ai pre { margin: 0; font-family: var(--mono); background: #0a0f1a; border: 1px solid #0f1a2b; padding: 10px; border-radius: 8px; overflow: auto; }

    #composer { border-top: 1px solid var(--border); background: var(--panel); padding: 8px; position: sticky; bottom: 0; }
    #composer .inner { display: grid; gap: 8px; grid-template-columns: 1fr auto; }
    textarea { width: 100%; min-height: 80px; resize: vertical; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
    button { background: var(--accent); color: #052e1a; border: none; border-radius: 8px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .toolbar { display: flex; gap: 10px; align-items: center; color: var(--muted); font-size: 13px; }
    .tag { display: inline-block; padding: 2px 6px; font-size: 12px; border-radius: 999px; background: #0b2530; color: #7dd3fc; border: 1px solid #12303f; }
    a.link { color: #93c5fd; text-decoration: none; }

    /* Typing indicator */
    .typing { display: inline-block; }
    .typing .dot { display: inline-block; width: 6px; height: 6px; margin: 0 2px; background: #9ca3af; border-radius: 50%; animation: blink 1.4s infinite both; }
    .typing .dot:nth-child(2){ animation-delay: .2s }
    .typing .dot:nth-child(3){ animation-delay: .4s }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.2 } 40% { opacity: 1 } }

    /* Loading visual with spinner image */
    .loading { display: inline-flex; align-items: center; gap: 8px; }
    .loading img { width: 18px; height: 18px; }
  </style>
</head>
<body>
<header>
  <h1>AI Chat – spring-gemini-ai</h1>
  <div class="right toolbar">
    <span class="tag">Backend: /api/ai/chat</span>
    <span class="tag">Sauvegarde à la demande: Sessions</span>
    <button id="btnNew">Nouvelle session</button>
    <button id="btnSave">Sauvegarder session</button>
    <button id="btnRename">Renommer</button>
    <button id="btnDelete" class="danger">Supprimer</button>
    <a class="link" href="/README.md" target="_blank">Doc</a>
  </div>
</header>
<main>
  <aside id="sidebar">
    <div class="top">
      <div style="font-size:12px;color:var(--muted)">Sessions (local)</div>
      <div class="actions">
        <button id="sNew">Nouvelle</button>
        <button id="sClear" class="danger">Tout effacer</button>
      </div>
    </div>
    <div id="sessionList"></div>
  </aside>
  <section id="chatArea">
    <div id="messages"></div>
    <div id="composer">
      <div class="inner">
        <textarea id="prompt" placeholder="Écrivez votre prompt... (Entrée pour envoyer, Maj+Entrée pour nouvelle ligne)"></textarea>
        <div>
          <button id="send">Envoyer</button>
        </div>
      </div>
      <div class="toolbar">
        <span id="sessionMeta"></span>
      </div>
    </div>
  </section>
</main>
<script>
  // ---------- Elements ----------
  const el = {
    messages: document.getElementById('messages'),
    prompt: document.getElementById('prompt'),
    send: document.getElementById('send'),
    sessionList: document.getElementById('sessionList'),
    sessionMeta: document.getElementById('sessionMeta'),
    btnNew: document.getElementById('btnNew'),
    btnSave: document.getElementById('btnSave'),
    btnRename: document.getElementById('btnRename'),
    btnDelete: document.getElementById('btnDelete'),
    sNew: document.getElementById('sNew'),
    sClear: document.getElementById('sClear'),
  };

  // ---------- Data model ----------
  const SESS_LS = 'ai_chat_sessions_v1';
  let sessions = loadSessions();
  let currentSession = createNewSession();

  function createNewSession(title) {
    return {
      id: 's_' + Date.now(),
      title: title || new Date().toLocaleString(),
      startedAt: Date.now(),
      finishedAt: 0,
      messages: []
    };
  }
  function loadSessions() {
    try { return JSON.parse(localStorage.getItem(SESS_LS) || '[]'); } catch { return []; }
  }
  function saveSessions() {
    localStorage.setItem(SESS_LS, JSON.stringify(sessions));
  }

  // ---------- Rendering ----------
  function clearMessagesView() { el.messages.innerHTML = ''; }
  function renderSessionMessages(sess) {
    clearMessagesView();
    if (!sess) return;
    for (const m of sess.messages) {
      if (m.role === 'user') addUserBubble(m.content);
      else addAiBubble(m.content);
    }
  }
  function renderSessionList() {
    el.sessionList.innerHTML = '';
    sessions.slice().reverse().forEach((s) => {
      const item = document.createElement('div');
      item.className = 'session-item' + (s.id === currentSession.id ? ' active' : '');
      const title = document.createElement('div'); title.className = 'session-title'; title.textContent = s.title || '(sans titre)';
      const meta = document.createElement('div'); meta.className = 'session-meta';
      const count = (s.messages || []).length;
      meta.textContent = `${new Date(s.startedAt).toLocaleString()} • ${count} msg` + (s.finishedAt ? ' • sauvegardée' : '');
      item.appendChild(title); item.appendChild(meta);
      item.onclick = () => { currentSession = JSON.parse(JSON.stringify(s)); renderSessionMessages(currentSession); renderSessionList(); updateSessionMeta(); };
      el.sessionList.appendChild(item);
    });
  }
  function updateSessionMeta() {
    const count = currentSession.messages.length;
    el.sessionMeta.textContent = `Session: ${currentSession.title} • ${count} message(s)` + (currentSession.finishedAt? ' • (sauvegardée)' : ' • (brouillon)');
  }

  // ---------- Helpers ----------
  function isAtBottom(container, threshold = 40) {
    return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
  }
  function smartScroll(container) {
    if (isAtBottom(container)) container.scrollTop = container.scrollHeight;
  }
  function addRow(role) {
    const row = document.createElement('div');
    row.className = 'row ' + role;
    el.messages.appendChild(row);
    return row;
  }
  function addUserBubble(text) {
    const row = addRow('user');
    const bubble = document.createElement('div');
    bubble.className = 'bubble user';
    bubble.textContent = text;
    row.appendChild(bubble);
    smartScroll(el.messages);
  }
  function formatIfJson(text) {
    try { const obj = JSON.parse(text); return { isJson: true, pretty: JSON.stringify(obj, null, 2), raw: text }; }
    catch { return { isJson: false, pretty: text, raw: text }; }
  }
  function addAiBubble(text, { loading = false } = {}) {
    const row = addRow('ai');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ai';
    const tools = document.createElement('div'); tools.className = 'tools';
    const content = document.createElement('div');
    if (loading) {
      const wrap = document.createElement('div'); wrap.className = 'loading';
      const img = document.createElement('img'); img.alt = 'Traitement en cours'; img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38 38" width="18" height="18"><g fill="none" stroke="%239ca3af" stroke-width="4"><circle cx="19" cy="19" r="16" stroke-opacity="0.2"/><path d="M35 19a16 16 0 0 1-16 16" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 19 19" to="360 19 19" dur="1s" repeatCount="indefinite"/></path></g></svg>';
      const t = document.createElement('span'); t.className = 'typing'; t.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      wrap.appendChild(img); wrap.appendChild(t); content.appendChild(wrap);
    } else {
      const fmt = formatIfJson(text);
      if (fmt.isJson) {
        const toggleBtn = document.createElement('button'); toggleBtn.className = 'btn-sm'; toggleBtn.textContent = 'Affichage: Préformaté'; let showPretty = true;
        const copyBtn = document.createElement('button'); copyBtn.className = 'btn-sm'; copyBtn.textContent = 'Copier';
        tools.appendChild(toggleBtn); tools.appendChild(copyBtn);
        const pre = document.createElement('pre'); pre.textContent = fmt.pretty; content.appendChild(pre);
        toggleBtn.onclick = () => { showPretty = !showPretty; toggleBtn.textContent = 'Affichage: ' + (showPretty ? 'Préformaté' : 'Brut'); pre.textContent = showPretty ? fmt.pretty : fmt.raw; };
        copyBtn.onclick = async () => { try { await navigator.clipboard.writeText(showPretty ? fmt.pretty : fmt.raw); copyBtn.textContent = 'Copié!'; setTimeout(()=>copyBtn.textContent='Copier', 1200);} catch(_){} };
      } else {
        const pre = document.createElement('pre'); pre.textContent = text; content.appendChild(pre);
        const copyBtn = document.createElement('button'); copyBtn.className = 'btn-sm'; copyBtn.textContent = 'Copier'; tools.appendChild(copyBtn);
        copyBtn.onclick = async () => { try { await navigator.clipboard.writeText(text); copyBtn.textContent = 'Copié!'; setTimeout(()=>copyBtn.textContent='Copier', 1200);} catch(_){} };
      }
    }
    if (tools.childElementCount > 0) bubble.appendChild(tools);
    bubble.appendChild(content);
    row.appendChild(bubble);
    smartScroll(el.messages);
    return { row, bubble, content };
  }

  // ---------- Chat send ----------
  async function sendPrompt() {
    const prompt = el.prompt.value.trim();
    if (!prompt) return;
    el.send.disabled = true;

    // model update
    currentSession.messages.push({ role: 'user', content: prompt, ts: Date.now() });
    addUserBubble(prompt);

    const loading = addAiBubble('', { loading: true });
    el.messages.scrollTop = el.messages.scrollHeight;

    try {
      const params = new URLSearchParams({ prompt });
      const res = await fetch(`/api/ai/chat?${params.toString()}`, { method: 'GET', headers: { 'Accept': 'text/plain' } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();

      loading.bubble.innerHTML = '';
      addAiBubble(text);
      loading.row.remove();

      currentSession.messages.push({ role: 'ai', content: text, ts: Date.now() });
      updateSessionMeta();
    } catch (e) {
      loading.bubble.innerHTML = '';
      loading.row.remove();
      addAiBubble('Erreur: ' + (e?.message || e));
    } finally {
      el.send.disabled = false;
      el.prompt.value = '';
      el.prompt.focus();
    }
  }

  // ---------- Session actions ----------
  async function saveCurrentSession() {
    if (!currentSession.messages.length) { alert('Aucun message dans cette session.'); return; }
    const payload = {
      title: currentSession.title,
      startedAt: currentSession.startedAt,
      finishedAt: Date.now(),
      messages: currentSession.messages
    };
    try {
      const res = await fetch('/api/ai/sessions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      currentSession.finishedAt = payload.finishedAt;
      // upsert in local list
      const idx = sessions.findIndex(s => s.id === currentSession.id);
      if (idx >= 0) sessions[idx] = JSON.parse(JSON.stringify(currentSession));
      else sessions.push(JSON.parse(JSON.stringify(currentSession)));
      saveSessions();
      renderSessionList();
      updateSessionMeta();
      alert('Session sauvegardée dans ./promptlog');
    } catch (e) {
      alert('Échec de sauvegarde: ' + (e?.message || e));
    }
  }
  function startNewSession(askSave = true) {
    if (askSave && currentSession.messages.length && !currentSession.finishedAt) {
      const doSave = confirm('Sauvegarder la session en cours avant de créer une nouvelle ?');
      if (doSave) { return saveCurrentSession().then(() => startNewSession(false)); }
    }
    // Archive current (as draft) in local list if it has content and not already there
    if (currentSession.messages.length) {
      const idx = sessions.findIndex(s => s.id === currentSession.id);
      if (idx < 0) { sessions.push(JSON.parse(JSON.stringify(currentSession))); saveSessions(); }
    }
    currentSession = createNewSession();
    clearMessagesView();
    renderSessionList();
    updateSessionMeta();
  }
  function renameCurrentSession() {
    const t = prompt('Nouveau titre de la session:', currentSession.title || '');
    if (t == null) return; // cancel
    currentSession.title = t.trim() || currentSession.title;
    updateSessionMeta();
    renderSessionList();
  }
  function deleteCurrentSession() {
    if (!confirm('Supprimer la session locale actuelle ?')) return;
    sessions = sessions.filter(s => s.id !== currentSession.id);
    saveSessions();
    startNewSession(false);
  }
  function clearAllSessions() {
    if (!confirm('Effacer toutes les sessions locales ?')) return;
    sessions = []; saveSessions(); renderSessionList();
  }

  // ---------- Wire UI ----------
  el.send.addEventListener('click', sendPrompt);
  el.prompt.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); } });
  el.btnNew.addEventListener('click', () => startNewSession(true));
  el.btnSave.addEventListener('click', () => saveCurrentSession());
  el.btnRename.addEventListener('click', () => renameCurrentSession());
  el.btnDelete.addEventListener('click', () => deleteCurrentSession());
  el.sNew.addEventListener('click', () => startNewSession(true));
  el.sClear.addEventListener('click', () => clearAllSessions());

  // ---------- Initial render ----------
  renderSessionList();
  updateSessionMeta();
</script>
</body>
</html>
